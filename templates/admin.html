<script>
    // ‚úÖ CONFIG: Point to your Vercel Proxy path
    const API_BASE = "/api/admin/api"; 
    
    let currentTable = '';
    let currentPage = 1;
    let currentSearch = '';
    
    // ‚úÖ NEW: Store the raw data globally so we don't stuff it into HTML attributes
    let currentData = []; 

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await fetch(`${API_BASE}/get_tables`);
            if (res.status === 403) {
                document.body.innerHTML = '<div class="container mt-5"><h1>403 Forbidden</h1><p>You are not logged in as admin.</p><a href="/" class="btn btn-primary">Go Login</a></div>';
                return;
            }
            const json = await res.json();
            renderNav(json.tables);
        } catch (e) {
            console.error(e);
            alert("Failed to load admin data. Ensure you are logged in.");
        }
    });

    function renderNav(tables) {
        const nav = document.getElementById('tableNav');
        let html = '';
        tables.forEach(t => {
            html += `<a class="nav-link" onclick="loadTable('${t}')">${t}</a>`;
        });
        nav.innerHTML = html;
        if(tables.length > 0) loadTable(tables[0]);
    }

    function loadTable(tableName) {
        currentTable = tableName;
        currentPage = 1;
        currentSearch = '';
        document.getElementById('searchInput').value = '';
        document.getElementById('currentTableName').innerText = tableName;
        document.getElementById('actionsDiv').style.display = 'flex';
        document.getElementById('paginationDiv').style.display = 'flex';
        
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        [...document.querySelectorAll('.nav-link')].forEach(el => {
            if(el.innerText === tableName) el.classList.add('active');
        });

        fetchData();
    }

    async function fetchData() {
        const res = await fetch(`${API_BASE}/fetch_table?table=${currentTable}&page=${currentPage}&search=${currentSearch}`);
        const json = await res.json();
        
        if (json.error) return alert(json.error);

        // ‚úÖ STORE DATA GLOBALLY
        currentData = json.data;

        renderTable(json.data);
        document.getElementById('pageInfo').innerText = `Page ${json.page} of ${json.total_pages} (${json.total} rows)`;
    }

    function renderTable(data) {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td class="p-3 text-center text-muted">No data found.</td></tr>';
            return;
        }

        const keys = Object.keys(data[0]).filter(k => k !== '_pk_val');
        let headRow = '<tr>';
        keys.forEach(k => headRow += `<th>${k}</th>`);
        headRow += '<th style="width: 100px;">Actions</th></tr>';
        thead.innerHTML = headRow;

        // ‚úÖ FIX: Loop with Index
        data.forEach((row, index) => {
            let tr = '<tr>';
            keys.forEach(k => {
                let val = row[k];
                if (val && String(val).length > 50) {
                    // Basic HTML escape for display
                    const safeVal = String(val).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
                    tr += `<td><div class="cell-truncate" title="Expand to view">${safeVal}</div></td>`;
                } else {
                    tr += `<td>${val !== null ? val : ''}</td>`;
                }
            });
            
            // ‚úÖ FIX: Pass only the INDEX, not the giant JSON object
            tr += `
                <td>
                    <button class="btn btn-sm btn-light border" onclick="viewRow(${index})">üëÅ</button>
                    <button class="btn btn-sm btn-light border text-danger" onclick="deleteRow('${row._pk_val}')">üóë</button>
                </td>`;
            tr += '</tr>';
            tbody.innerHTML += tr;
        });
    }

    // ‚úÖ FIX: Look up the data from the global array using the index
    function viewRow(index) {
        const rowData = currentData[index];
        if (!rowData) return;
        
        // Clone to avoid modifying the table data
        const displayData = {...rowData};
        delete displayData._pk_val; // Hide internal key from view
        
        document.getElementById('modalContent').innerText = JSON.stringify(displayData, null, 2);
        new bootstrap.Modal(document.getElementById('viewModal')).show();
    }

    document.getElementById('searchInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            currentSearch = e.target.value;
            currentPage = 1;
            fetchData();
        }
    });

    function changePage(dir) {
        if (currentPage + dir < 1) return;
        currentPage += dir;
        fetchData();
    }

    async function deleteRow(pkVal) {
        if (!confirm('Delete row?')) return;
        const res = await fetch(`${API_BASE}/delete_row`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table: currentTable, pk_val: pkVal })
        });
        if (res.ok) fetchData();
        else alert("Delete failed");
    }

    async function confirmClearTable() {
        if (!confirm(`‚ö†Ô∏è DANGER: Are you sure you want to delete ALL data in ${currentTable}? This cannot be undone.`)) return;
        const res = await fetch(`${API_BASE}/clear_table`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table: currentTable })
        });
        if (res.ok) fetchData();
        else alert("Clear failed");
    }
</script>
