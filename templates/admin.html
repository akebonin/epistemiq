<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epistemiq Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-size: 0.9rem; }
        .sidebar { height: 100vh; overflow-y: auto; background: #fff; border-right: 1px solid #dee2e6; }
        .nav-link { color: #333; font-weight: 500; padding: 10px 20px; cursor: pointer; }
        .nav-link:hover { background-color: #f8f9fa; color: #0d6efd; }
        .nav-link.active { background-color: #e7f1ff; color: #0d6efd; border-right: 3px solid #0d6efd; }
        .cell-truncate { 
            max-width: 200px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .json-cell { font-family: monospace; font-size: 0.8em; color: #d63384; }
        .modal-pre { white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 60vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-0 pt-3">
            <h5 class="px-3 mb-3 text-primary fw-bold">‚ö° Cache Browser</h5>
            <nav class="nav flex-column" id="tableNav">
                <span class="text-muted px-3">Loading tables...</span>
            </nav>
            <div class="mt-4 px-3">
                <a href="/" class="btn btn-outline-secondary btn-sm w-100">‚Üê Back to App</a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-10 p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 id="currentTableName">Dashboard</h3>
                <div class="d-flex gap-2" id="actionsDiv" style="display:none !important;">
                    <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search..." style="width: 250px;">
                    <button class="btn btn-danger btn-sm" onclick="confirmClearTable()">‚ö†Ô∏è Clear Table</button>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0" id="dataTable">
                            <thead class="table-light" id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center" id="paginationDiv" style="display:none;">
                    <span id="pageInfo" class="text-muted">Page 1</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="changePage(-1)">Previous</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="changePage(1)">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content Modal -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Entry Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="modalContent" class="modal-pre"></pre>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ‚úÖ CONFIG: Point to your Vercel Proxy path
    const API_BASE = "/api/admin/api"; 
    
    let currentTable = '';
    let currentPage = 1;
    let currentSearch = '';
    let currentData = []; 

    // ‚úÖ FIX: Everything starts ONLY after HTML is ready
    document.addEventListener('DOMContentLoaded', async () => {
        
        // 1. Attach Search Listener safely
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    currentSearch = e.target.value;
                    currentPage = 1;
                    fetchData();
                }
            });
        }

        // 2. Fetch Tables
        try {
            const res = await fetch(`${API_BASE}/get_tables`);
            if (res.status === 403) {
                document.body.innerHTML = '<div class="container mt-5"><h1>403 Forbidden</h1><p>You are not logged in as admin.</p><a href="/" class="btn btn-primary">Go Login</a></div>';
                return;
            }
            const json = await res.json();
            renderNav(json.tables);
        } catch (e) {
            console.error(e);
            const nav = document.getElementById('tableNav');
            if(nav) nav.innerHTML = '<span class="text-danger px-3">Connection Failed</span>';
        }
    });

    function renderNav(tables) {
        const nav = document.getElementById('tableNav');
        if (!nav) return;
        
        let html = '';
        tables.forEach(t => {
            html += `<a class="nav-link" onclick="loadTable('${t}')">${t}</a>`;
        });
        nav.innerHTML = html;
        
        // Load first table automatically
        if(tables.length > 0) loadTable(tables[0]);
    }

    function loadTable(tableName) {
        currentTable = tableName;
        currentPage = 1;
        currentSearch = '';
        
        const searchEl = document.getElementById('searchInput');
        if(searchEl) searchEl.value = '';
        
        document.getElementById('currentTableName').innerText = tableName;
        document.getElementById('actionsDiv').style.setProperty('display', 'flex', 'important');
        document.getElementById('paginationDiv').style.display = 'flex';
        
        // Update Sidebar
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        const activeLink = [...document.querySelectorAll('.nav-link')].find(el => el.innerText === tableName);
        if(activeLink) activeLink.classList.add('active');

        fetchData();
    }

    async function fetchData() {
        const res = await fetch(`${API_BASE}/fetch_table?table=${currentTable}&page=${currentPage}&search=${currentSearch}`);
        const json = await res.json();
        
        if (json.error) return alert(json.error);

        // Store data globally to prevent HTML attribute errors
        currentData = json.data;

        renderTable(json.data);
        document.getElementById('pageInfo').innerText = `Page ${json.page} of ${json.total_pages} (${json.total} rows)`;
    }

    function renderTable(data) {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td class="p-3 text-center text-muted">No data found.</td></tr>';
            return;
        }

        // Headers
        const keys = Object.keys(data[0]).filter(k => k !== '_pk_val');
        let headRow = '<tr>';
        keys.forEach(k => headRow += `<th>${k}</th>`);
        headRow += '<th style="width: 100px;">Actions</th></tr>';
        thead.innerHTML = headRow;

        // Rows
        data.forEach((row, index) => {
            let tr = '<tr>';
            keys.forEach(k => {
                let val = row[k];
                if (val && String(val).length > 50) {
                    const safeVal = String(val).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
                    tr += `<td><div class="cell-truncate" title="Expand to view">${safeVal}</div></td>`;
                } else {
                    tr += `<td>${val !== null ? val : ''}</td>`;
                }
            });
            
            // Use INDEX to reference global data
            tr += `
                <td>
                    <button class="btn btn-sm btn-light border" onclick="viewRow(${index})">üëÅ</button>
                    <button class="btn btn-sm btn-light border text-danger" onclick="deleteRow('${row._pk_val}')">üóë</button>
                </td>`;
            tr += '</tr>';
            tbody.innerHTML += tr;
        });
    }

    function viewRow(index) {
        const rowData = currentData[index];
        if (!rowData) return;
        
        const displayData = {...rowData};
        delete displayData._pk_val; 
        
        document.getElementById('modalContent').innerText = JSON.stringify(displayData, null, 2);
        new bootstrap.Modal(document.getElementById('viewModal')).show();
    }

    function changePage(dir) {
        if (currentPage + dir < 1) return;
        currentPage += dir;
        fetchData();
    }

    async function deleteRow(pkVal) {
        if (!confirm('Delete row?')) return;
        const res = await fetch(`${API_BASE}/delete_row`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table: currentTable, pk_val: pkVal })
        });
        if (res.ok) fetchData();
        else alert("Delete failed");
    }

    async function confirmClearTable() {
        if (!confirm(`‚ö†Ô∏è DANGER: Are you sure you want to delete ALL data in ${currentTable}? This cannot be undone.`)) return;
        const res = await fetch(`${API_BASE}/clear_table`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table: currentTable })
        });
        if (res.ok) fetchData();
        else alert("Clear failed");
    }
</script>

</body>
</html>
