<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epistemiq Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-size: 0.85rem; }
        .sidebar { height: 100vh; overflow-y: auto; background: #fff; border-right: 1px solid #dee2e6; position: fixed; width: 16.66%; }
        .main-content { margin-left: 16.66%; width: 83.33%; }
        .nav-link { color: #333; font-weight: 500; padding: 10px 20px; cursor: pointer; }
        .nav-link:hover { background-color: #f8f9fa; color: #0d6efd; }
        .nav-link.active { background-color: #e7f1ff; color: #0d6efd; border-right: 3px solid #0d6efd; }
        
        .cell-truncate { 
            max-width: 250px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            font-family: monospace;
            cursor: pointer;
        }
        .cell-truncate:hover { background-color: #f1f1f1; }
        
        .modal-pre { 
            white-space: pre-wrap; 
            background: #212529; 
            color: #00ff9d; 
            padding: 15px; 
            border-radius: 5px; 
            max-height: 70vh; 
            overflow-y: auto; 
            font-family: 'Consolas', monospace;
        }
        th { font-weight: 600; text-transform: uppercase; font-size: 0.75rem; color: #6c757d; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-0 pt-3">
            <div class="px-3 mb-4">
                <h5 class="fw-bold text-primary"><i class="bi bi-database"></i> DB Admin</h5>
                <small class="text-muted">Unified Architecture</small>
            </div>
            
            <nav class="nav flex-column" id="tableNav">
                <span class="text-muted px-3">Loading schema...</span>
            </nav>
            <div class="mt-4 px-3">
                <a href="/" class="btn btn-outline-secondary btn-sm w-100">‚Üê Back to App</a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-10 main-content p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 id="currentTableName" class="m-0">Dashboard</h3>
                <div class="d-flex gap-2 align-items-center" id="actionsDiv" style="display:none !important;">
                    <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search (Enter)..." style="width: 250px;">
                    <button class="btn btn-outline-secondary btn-sm" onclick="fetchData()">üîÑ Refresh</button>
                    <button class="btn btn-danger btn-sm" onclick="confirmClearTable()">‚ö†Ô∏è Clear Table</button>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="dataTable">
                            <thead class="table-light" id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white d-flex justify-content-between align-items-center" id="paginationDiv" style="display:none;">
                    <span id="pageInfo" class="text-muted">Loading...</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="changePage(-1)">Previous</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="changePage(1)">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Raw Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-dark">
                <pre id="modalContent" class="modal-pre"></pre>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

<!-- Publish Modal -->
<div class="modal fade" id="publishModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Publish to The Compass</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pub_analysis_id">
                
                <!-- [Inside .modal-body of #publishModal] -->

                <div class="mb-3">
                    <label class="form-label">SEO Headline</label>
                    <input type="text" class="form-control" id="pub_title" oninput="document.getElementById('pub_slug').value = generateSlug(this.value)">
                </div>

                <div class="mb-3">
                    <label class="form-label">Cover Image URL</label>
                    <input type="text" class="form-control" id="pub_image" placeholder="https://example.com/image.jpg">
                    <div class="form-text">Paste a URL from Unsplash or your uploads.</div>
                </div>

                <!-- ‚úÖ NEW: Summary Input -->
                <div class="mb-3">
                    <label class="form-label">Editorial Context / Summary</label>
                    <textarea class="form-control" id="pub_summary" rows="6" placeholder="Explain why this analysis matters..."></textarea>
                    <!-- ‚úÖ Update help text -->
                    <div class="form-text">
                        This will appear at the top of the article. Supports <b>Markdown</b>: Use <code>**bold**</code> for emphasis, <code>-</code> for bullets, and double-enter for paragraphs.
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">URL Slug</label>
                    <!-- ... existing slug input ... -->
                    <div class="input-group">
                        <span class="input-group-text">/compass/</span>
                        <input type="text" class="form-control" id="pub_slug">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" id="btn_do_unpublish" onclick="submitPublish('unpublish')">Unpublish</button>
                <button type="button" class="btn btn-primary" id="btn_do_publish" onclick="submitPublish('publish')">üöÄ Publish Live</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api/admin';
    let currentTable = '';
    let currentPage = 1;
    let currentSearch = '';
    let currentData = []; 

    document.addEventListener('DOMContentLoaded', async () => {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    currentSearch = e.target.value;
                    currentPage = 1;
                    fetchData();
                }
            });
        }

        try {
            const res = await fetch(`${API_BASE}/get_tables`);
            if (res.status === 403) {
                document.body.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center vh-100 bg-light">
                        <div class="text-center">
                            <h1 class="display-4 text-danger">403 Forbidden</h1>
                            <p class="lead">You must be logged in as an admin.</p>
                            <a href="/" class="btn btn-primary">Login Page</a>
                        </div>
                    </div>`;
                return;
            }
            const json = await res.json();
            renderNav(json.tables);
        } catch (e) {
            console.error(e);
            document.getElementById('tableNav').innerHTML = '<span class="text-danger px-3">Connection Failed</span>';
        }
    });

    function renderNav(tables) {
        const nav = document.getElementById('tableNav');
        let html = '';
        tables.forEach(t => {
            html += `<a class="nav-link" onclick="loadTable('${t}')"><i class="bi bi-table me-2"></i>${t}</a>`;
        });
        nav.innerHTML = html;
        if(tables.length > 0) loadTable(tables[0]); // Load first table
    }

    function loadTable(tableName) {
        currentTable = tableName;
        currentPage = 1;
        currentSearch = '';
        
        const searchEl = document.getElementById('searchInput');
        if(searchEl) searchEl.value = '';
        
        document.getElementById('currentTableName').innerText = tableName;
        document.getElementById('actionsDiv').style.setProperty('display', 'flex', 'important');
        document.getElementById('paginationDiv').style.display = 'flex';
        
        // Active state
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        const activeLink = [...document.querySelectorAll('.nav-link')].find(el => el.innerText.includes(tableName));
        if(activeLink) activeLink.classList.add('active');

        fetchData();
    }

    async function fetchData() {
        const res = await fetch(`${API_BASE}/fetch_table?table=${currentTable}&page=${currentPage}&search=${encodeURIComponent(currentSearch)}`);
        const json = await res.json();
        
        if (json.error) return alert(json.error);

        currentData = json.data;
        renderTable(json.data);
        document.getElementById('pageInfo').innerText = `Page ${json.page} of ${json.total_pages} (${json.total} records)`;
    }

    function renderTable(data) {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td class="p-5 text-center text-muted">No data found.</td></tr>';
            return;
        }

        // Headers (Exclude internal keys)
        const keys = Object.keys(data[0]).filter(k => k !== '_pk_val');
        let headRow = '<tr>';
        keys.forEach(k => headRow += `<th>${k.replace(/_/g, ' ')}</th>`);
        headRow += '<th class="text-end">Actions</th></tr>';
        thead.innerHTML = headRow;

        // Rows
        data.forEach((row, index) => {
            let tr = '<tr>';
            keys.forEach(k => {
                let val = row[k];
                let displayVal = val === null ? '<span class="text-muted">NULL</span>' : String(val);
                
                // Truncate long JSON or Text
                if (displayVal.length > 60) {
                    // Escape HTML for safety before putting in div
                    const safeVal = displayVal.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    tr += `<td><div class="cell-truncate" onclick="viewRow(${index})">${safeVal}</div></td>`;
                } else {
                    tr += `<td>${displayVal}</td>`;
                }
            });
            
            // ‚úÖ PUBLISHING / EDITING LOGIC
            let extraActions = '';
            if (currentTable === 'analyses') {
                const isPub = row.is_published;
                // Escape single quotes for the inline onclick handler
                const rowString = encodeURIComponent(JSON.stringify(row)).replace(/'/g, "%27");
                
                if (isPub) {
                    // Already Published -> Show "Edit" (Green)
                    extraActions = `
                        <button class="btn btn-sm btn-outline-success me-1" onclick="openPublishModal('${rowString}')" title="Edit Article">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                    `;
                } else {
                    // Not Published -> Show "Publish" (Blue)
                    extraActions = `
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="openPublishModal('${rowString}')" title="Publish Article">
                            <i class="bi bi-cloud-upload"></i> Publish
                        </button>
                    `;
                }
            }

            tr += `
                <td class="text-end" style="white-space:nowrap;">
                    ${extraActions}
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="viewRow(${index})" title="View Raw JSON"><i class="bi bi-eye"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRow('${row._pk_val}')" title="Delete Row"><i class="bi bi-trash"></i></button>
                    </div>
                </td>`;
            tr += '</tr>';
            tbody.innerHTML += tr;
        });
    }

    function viewRow(index) {
        const rowData = currentData[index];
        if (!rowData) return;
        
        const displayData = {...rowData};
        delete displayData._pk_val; 
        
        // Try to parse JSON strings for pretty display
        for (const key in displayData) {
            if (typeof displayData[key] === 'string' && (displayData[key].startsWith('{') || displayData[key].startsWith('['))) {
                try {
                    displayData[key] = JSON.parse(displayData[key]);
                } catch(e) {}
            }
        }

        document.getElementById('modalContent').innerText = JSON.stringify(displayData, null, 2);
        new bootstrap.Modal(document.getElementById('viewModal')).show();
    }

    function changePage(dir) {
        if (currentPage + dir < 1) return;
        currentPage += dir;
        fetchData();
    }

    async function deleteRow(pkVal) {
        if (!confirm('Are you sure you want to delete this record?')) return;
        
        const res = await fetch(`${API_BASE}/delete_row`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table: currentTable, pk_val: pkVal })
        });
        
        if (res.ok) {
            fetchData();
        } else {
            const err = await res.json();
            alert("Delete failed: " + (err.error || "Unknown error"));
        }
    }

    async function confirmClearTable() {
        if (!confirm(`‚ö†Ô∏è DANGER: This will delete ALL data in '${currentTable}'.\n\nAre you sure?`)) return;
        
        const res = await fetch(`${API_BASE}/clear_table`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table: currentTable })
        });
        
        if (res.ok) {
            fetchData();
        } else {
            const err = await res.json();
            alert("Clear failed: " + (err.error || "Unknown error"));
        }
    }
    
    function generateSlug(text) {
        return text.toString().toLowerCase()
            .trim()
            .replace(/\s+/g, '-')           // Replace spaces with -
            .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
            .replace(/\-\-+/g, '-')         // Replace multiple - with single -
            .replace(/^-+/, '')             // Trim - from start
            .replace(/-+$/, '');            // Trim - from end
    }

    function openPublishModal(rowString) {
        // Decode the data passed from the table row
        const row = JSON.parse(decodeURIComponent(rowString));
        
        // 1. Set ID
        document.getElementById('pub_analysis_id').value = row.analysis_id;
        
        // 2. Set Title
        const defaultTitle = row.published_title || (row.canonical_text ? row.canonical_text.substring(0, 60) : 'New Analysis');
        document.getElementById('pub_title').value = defaultTitle;
        
        // 3. Set Slug
        document.getElementById('pub_slug').value = row.published_slug || generateSlug(defaultTitle);
        
        // 4. Set Summary
        document.getElementById('pub_summary').value = row.published_summary || ''; 

        // 5. Set Image URL
        const imgInput = document.getElementById('pub_image');
        if(imgInput) imgInput.value = row.published_image_url || ''; 
        
        // 6. ‚úÖ FIX: Button Logic
        const btnPublish = document.getElementById('btn_do_publish');
        const btnUnpublish = document.getElementById('btn_do_unpublish');

        if (row.is_published) {
            // MODE: EDITING AN EXISTING ARTICLE
            // Show BOTH buttons. Allow updating without unpublishing.
            
            btnPublish.style.display = 'inline-block';
            btnPublish.innerHTML = 'üíæ Update Changes'; // Change text to "Update"
            btnPublish.className = 'btn btn-success';   // Change color to Green
            
            btnUnpublish.style.display = 'inline-block'; // Keep option to take down
        } else {
            // MODE: PUBLISHING NEW
            btnPublish.style.display = 'inline-block';
            btnPublish.innerHTML = 'üöÄ Publish Live';
            btnPublish.className = 'btn btn-primary'; // Blue
            
            btnUnpublish.style.display = 'none';
        }

        // 7. Show Modal
        new bootstrap.Modal(document.getElementById('publishModal')).show();
    }

    async function submitPublish(action) {
        const payload = {
            analysis_id: document.getElementById('pub_analysis_id').value,
            title: document.getElementById('pub_title').value,
            slug: document.getElementById('pub_slug').value,
            summary: document.getElementById('pub_summary').value,
            image_url: document.getElementById('pub_image').value, // ‚úÖ Send Image to Backend
            action: action
        };

        try {
            const res = await fetch(`${API_BASE}/publish_analysis`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                const modalEl = document.getElementById('publishModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                fetchData(); 
            } else {
                const err = await res.json();
                alert("Error: " + (err.error || "Unknown error"));
            }
        } catch (e) {
            console.error(e);
            alert("Network error occurred.");
        }
    }

</script>

</body>
</html>
